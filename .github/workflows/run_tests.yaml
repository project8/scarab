name: Run Tests

on:
  push:
    branches: [ 'main', 'develop' ]
  pull_request:

  workflow_dispatch:

jobs:

  RunTests:

    runs-on: ${{ matrix.os }}

    strategy:
      matrix:
        fail-fast: [false]
        os: [ubuntu-latest, macos-latest]

    steps:

      - name: Checkout the repo 
        uses: actions/checkout@v4
        with:
          submodules: recursive

      - name: Install dependencies -- Mac
        # pybind11 is manually installed because we need to use the smart_holder branch
        if: startsWith(matrix.os, 'macos')
        run: |
          brew install \
            boost \
            quill \
            rabbitmq-c \
            rapidjson \
            yaml-cpp
          git clone https://github.com/pybind/pybind11.git
          cd pybind11
          git checkout smart_holder
          mkdir build
          cd build
          cmake -DPYBIND11_TEST=FALSE ..
          make -j2 install


      - name: Install dependencies -- Linux
        # pybind11 is manually installed because we need to use the smart_holder branch
        # quill is manually installed because it's not available in apt
        if: startsWith(matrix.os, 'ubuntu')
        run: |
          sudo apt-get update
          DEBIAN_FRONTEND=noninteractive sudo apt-get install -y \
            libboost-all-dev \
            rapidjson-dev \
            libyaml-cpp-dev
          git clone https://github.com/pybind/pybind11.git
          cd pybind11
          git checkout smart_holder
          mkdir build
          cd build
          sudo cmake -DPYBIND11_TEST=FALSE ..
          sudo make -j2 install
          cd ../..
          git clone https://github.com/odygrd/quill.git
          cd quill
          git checkout v8.1.0
          mkdir build
          cd build
          sudo cmake ..
          sudo make install

      - name: Configure
        run: |
          mkdir build
          cd build
          cmake .. -DScarab_ENABLE_TESTING=TRUE -DScarab_BUILD_PYTHON=TRUE

      - name: Build
        run: |
          cd build
          make -j2 install

      - name: Run tests
        run: |
          cd build
          ctest --output-on-failure

# For debugging
      - name: Setup tmate session
        if: ${{ ! success() }}
        uses: mxschmitt/action-tmate@v3

